<!doctype html>
<html lang="zh">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Color War</title>
<style>
html,body{margin:0;height:100%;background:#111;overflow:hidden;font-family:sans-serif}
#ui{position:fixed;left:12px;top:12px;color:#fff;z-index:10}
canvas{width:100vw;height:100vh;display:block}
</style>
</head>
<body>

<div id="ui">
Room:<input id="room" value="room1"/>
WS:<input id="ws" value="wss://color-war-server.onrender.com"/>
<button id="connect">Connect</button>
<button id="motion">Enable Motion</button>
</div>

<canvas id="c"></canvas>

<script>
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let role = null; // "A" or "B"

function resize(){
  canvas.width=innerWidth;
  canvas.height=innerHeight;
}
resize();
addEventListener("resize",resize);

let ws=null;
let p=0.5;
let raw=0;
let power=0;
let motionEnabled=false;

// ===== 关键：监听手机倾斜 =====
window.addEventListener("deviceorientation",(e)=>{
  if(!motionEnabled) return;
 const gamma = e.gamma || 0; // 左右倾斜：右正左负（一般如此）

// role 决定“哪边倾斜才算发力”
const sideSign = (role === "B") ? +1 : -1; // B(右)要右倾；A(左)要左倾

// 将 “朝自己方向的倾斜” 映射到 0~1
// 10° 以下当作没发力，60° 接近满力
const v = (sideSign * gamma - 10) / 50;
raw = Math.max(0, Math.min(1, v));

},true);

function connect(){
  const room = document.getElementById("room").value.trim() || "room1";
  const myId = "p" + Math.random().toString(16).slice(2,6);

  ws = new WebSocket(document.getElementById("ws").value);

  ws.onopen = ()=>{
    ws.send(JSON.stringify({ type:"join", room: room, id: myId }));
  };

 ws.onmessage = (e)=>{
  const d = JSON.parse(e.data);

  if(d.type === "role"){
    role = d.role; // "A" or "B"
  }

  if(d.type === "state"){
    p = d.p;
  }
};

}


// ===== iPhone 权限 =====
async function enableMotion(){
  try{
    if(typeof DeviceOrientationEvent!=="undefined" &&
       typeof DeviceOrientationEvent.requestPermission==="function"){
       await DeviceOrientationEvent.requestPermission();
    }
    motionEnabled=true;
  }catch(e){}
}

document.getElementById("connect").onclick=connect;
document.getElementById("motion").onclick=enableMotion;

function loop(){
  power+=(raw-power)*0.1;

  if(ws && ws.readyState===1){
    ws.send(JSON.stringify({type:"power",value:power}));
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ff4d7d";
  ctx.fillRect(0,0,canvas.width*p,canvas.height);
  ctx.fillStyle="#40c4ff";
  ctx.fillRect(canvas.width*p,0,canvas.width,canvas.height);

  // 调试文字
 ctx.fillStyle="white";
ctx.font="24px sans-serif";
ctx.textAlign="center";

ctx.fillText("raw = " + raw.toFixed(2), canvas.width/2, canvas.height/2 - 20);
ctx.fillText("power = " + power.toFixed(2), canvas.width/2, canvas.height/2 + 20);

ctx.textAlign="left"; // 还原对齐方式


  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
